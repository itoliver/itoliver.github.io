<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Oliver Blog</title>
  
  <subtitle>To Be a Batter Me</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://ippai.top/"/>
  <updated>2018-04-08T12:29:09.000Z</updated>
  <id>http://ippai.top/</id>
  
  <author>
    <name>Oliver</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>docker_swarm集群</title>
    <link href="http://ippai.top/2018/04/08/docker-swarm%E9%9B%86%E7%BE%A4/"/>
    <id>http://ippai.top/2018/04/08/docker-swarm集群/</id>
    <published>2018-04-08T03:17:05.000Z</published>
    <updated>2018-04-08T12:29:09.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="docker-swarm集群"><a href="#docker-swarm集群" class="headerlink" title="docker swarm集群"></a>docker swarm集群</h1><a id="more"></a><p>环境：centos7.2<br>192.168.1.14 master swarm-manager rethinkdb controller swarm-agent consul-s1 registrator consul-template(nginx)<br>192.168.1.15 slave-1 registrator swarm-agent consul-s2<br>192.168.1.16 slave-2 registrator swarm-agent consul-s3<br>docker-engine    17.05.0-ce</p><h2 id="一、搭建docker集群环境"><a href="#一、搭建docker集群环境" class="headerlink" title="一、搭建docker集群环境"></a>一、搭建docker集群环境</h2><h1 id="1、先检查是否安装旧版本docker"><a href="#1、先检查是否安装旧版本docker" class="headerlink" title="1、先检查是否安装旧版本docker"></a>1、先检查是否安装旧版本docker</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -<span class="keyword">qa</span>|<span class="keyword">grep</span> docker</span><br></pre></td></tr></table></figure><p>如果有就先卸载<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="builtin-name">remove</span> docker*</span><br></pre></td></tr></table></figure></p><h1 id="2、添加docker-repo安装源，写入文件"><a href="#2、添加docker-repo安装源，写入文件" class="headerlink" title="2、添加docker.repo安装源，写入文件"></a>2、添加docker.repo安装源，写入文件</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/yum.repos.d/docker.repo&lt;&lt;EOF</span><br><span class="line">[dockerrepo]</span><br><span class="line">name=Docker Repository</span><br><span class="line">baseurl=https://yum.dockerproject.org/repo/main/centos/7/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://yum.dockerproject.org/gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="3、安装docker"><a href="#3、安装docker" class="headerlink" title="3、安装docker"></a>3、安装docker</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> docker-<span class="keyword">engine</span></span><br></pre></td></tr></table></figure><h1 id="4、配置防火墙"><a href="#4、配置防火墙" class="headerlink" title="4、配置防火墙"></a>4、配置防火墙</h1><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=&#123;<span class="number">2375</span>/tcp,<span class="number">3375</span>/tcp,<span class="number">8500</span>/tcp,<span class="number">8300</span>/tcp,<span class="number">8301</span>/tcp,<span class="number">8301</span>/udp,<span class="number">8302</span>/tcp,<span class="number">8302</span>/udp,<span class="number">8400</span>/tcp,<span class="number">8500</span>/tcp,<span class="number">8600</span>/tcp,<span class="number">8600</span>/udp,<span class="number">8080</span>/tcp,<span class="number">28015</span>/tcp,<span class="number">29015</span>/tcp&#125;</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --<span class="type">list</span>-all</span><br></pre></td></tr></table></figure><h1 id="iptables内容（使用的iptables）"><a href="#iptables内容（使用的iptables）" class="headerlink" title="iptables内容（使用的iptables）"></a>iptables内容（使用的iptables）</h1><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">:INPUT ACCEPT [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">:OUTPUT ACCEPT [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">:POSTROUTING ACCEPT [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">:DOCKER - [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A OUTPUT ! -d <span class="number">127.0</span>.<span class="number">0.0</span>/<span class="number">8</span> -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A POSTROUTING -s <span class="number">192.168</span>.<span class="number">0.0</span>/<span class="number">16</span> ! -o docker0 -j MASQUERADE</span><br><span class="line">COMMIT</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">:FORWARD ACCEPT [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">:OUTPUT ACCEPT [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">:DOCKER - [<span class="number">0</span>:<span class="number">0</span>]</span><br><span class="line">-A FORWARD -o docker0 -j DOCKER</span><br><span class="line">-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A FORWARD -i docker0 ! -o docker0 -j ACCEPT</span><br><span class="line">-A FORWARD -i docker0 -o docker0 -j ACCEPT</span><br><span class="line">-A INPUT -m <span class="keyword">state</span> --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -p icmp -j ACCEPT</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">21</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">22</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">80</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">2375</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">3375</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">8080</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">8300</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">8301</span> -j ACCEPT</span><br><span class="line">-A INPUT -p udp -m <span class="keyword">state</span> --state NEW -m udp --dport <span class="number">8301</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">8302</span> -j ACCEPT</span><br><span class="line">-A INPUT -p udp -m <span class="keyword">state</span> --state NEW -m udp --dport <span class="number">8302</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">8400</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">8500</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">8600</span> -j ACCEPT</span><br><span class="line">-A INPUT -p udp -m <span class="keyword">state</span> --state NEW -m udp --dport <span class="number">8600</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">28015</span> -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">29015</span> -j ACCEPT</span><br><span class="line"><span class="comment">#-A INPUT -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line"><span class="comment">#-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure><h1 id="5、增加tcp监听端口-并配置docker加速"><a href="#5、增加tcp监听端口-并配置docker加速" class="headerlink" title="5、增加tcp监听端口,并配置docker加速"></a>5、增加tcp监听端口,并配置docker加速</h1><p>修改/lib/systemd/system/docker.service<br>daocloud加速<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/ExecStart=.*/ExecStart=<span class="symbol">\/</span>usr<span class="symbol">\/</span>bin<span class="symbol">\/</span>dockerd -H unix<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span><span class="symbol">\/</span>var<span class="symbol">\/</span>run<span class="symbol">\/</span>docker.sock -D -H tcp<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span>0.0.0.0<span class="symbol">\:</span>2375 --registry-mirror=http<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span>a582cc4e.m.daocloud.io --live-restore/g' /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure></p><p>私库<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/ExecStart=.*/ExecStart=<span class="symbol">\/</span>usr<span class="symbol">\/</span>bin<span class="symbol">\/</span>dockerd -H unix<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span><span class="symbol">\/</span>var<span class="symbol">\/</span>run<span class="symbol">\/</span>docker.sock -D -H tcp<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span>0.0.0.0<span class="symbol">\:</span>2375 --registry-mirror=http<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span>a582cc4e.m.daocloud.io --insecure-registry 192.168.1.14<span class="symbol">\:</span>5000 --live-restore/g' /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure></p><p>阿里云加速<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/ExecStart=.*/ExecStart=<span class="symbol">\/</span>usr<span class="symbol">\/</span>bin<span class="symbol">\/</span>dockerd -H unix<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span><span class="symbol">\/</span>var<span class="symbol">\/</span>run<span class="symbol">\/</span>docker.sock -D -H tcp<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span>0.0.0.0<span class="symbol">\:</span>2375 --registry-mirror=https<span class="symbol">\:</span><span class="symbol">\/</span><span class="symbol">\/</span>0xl18ug0.mirror.aliyuncs.com --live-restore/g' /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure></p><h1 id="6、重启docker"><a href="#6、重启docker" class="headerlink" title="6、重启docker"></a>6、重启docker</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> docker.service</span><br><span class="line">systemctl restart docker.service</span><br><span class="line">ps -ef |grep docker  <span class="comment">#能看到docker启动以及2375端口</span></span><br></pre></td></tr></table></figure><p>#7、安装pip以及docker api<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> epel-<span class="keyword">release</span></span><br><span class="line">yum -y <span class="keyword">install</span> python-pip</span><br><span class="line">pip <span class="keyword">install</span> docker-py docker-compose</span><br></pre></td></tr></table></figure></p><h1 id="8、创建consul用户及组"><a href="#8、创建consul用户及组" class="headerlink" title="8、创建consul用户及组"></a>8、创建consul用户及组</h1><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd -g <span class="number">1005</span> consul</span><br><span class="line">useradd -u <span class="number">105</span> -g <span class="number">1005</span> -s /bin/false consul</span><br></pre></td></tr></table></figure><h1 id="9、创建consul数据存储文件夹"><a href="#9、创建consul数据存储文件夹" class="headerlink" title="9、创建consul数据存储文件夹"></a>9、创建consul数据存储文件夹</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -<span class="keyword">p</span> /<span class="keyword">opt</span>/consul/&#123;data,<span class="keyword">conf</span>&#125;</span><br><span class="line">chown -R consu<span class="variable">l:</span> /<span class="keyword">opt</span>/consul</span><br></pre></td></tr></table></figure><h1 id="10、设置主机hosts，有多少台主机，就需要设置多少hosts"><a href="#10、设置主机hosts，有多少台主机，就需要设置多少hosts" class="headerlink" title="10、设置主机hosts，有多少台主机，就需要设置多少hosts"></a>10、设置主机hosts，有多少台主机，就需要设置多少hosts</h1><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.14</span>    master.localhost.com</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.15</span>    slave1.localhost.com</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.16</span>    slave2.localhost.com</span><br></pre></td></tr></table></figure><h2 id="二、配置consul-cluster"><a href="#二、配置consul-cluster" class="headerlink" title="二、配置consul cluster"></a>二、配置consul cluster</h2><h1 id="1、拉取consul镜像"><a href="#1、拉取consul镜像" class="headerlink" title="1、拉取consul镜像"></a>1、拉取consul镜像</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> pull progrium/consul</span><br></pre></td></tr></table></figure><p>#提示：目录没有官方出consul镜像，以上consul镜像是官方推荐的第三方docker image</p><h1 id="2、启动consul-server-192-168-1-14"><a href="#2、启动consul-server-192-168-1-14" class="headerlink" title="2、启动consul server 192.168.1.14"></a>2、启动consul server 192.168.1.14</h1><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">p <span class="number">8300</span><span class="symbol">:</span><span class="number">8300</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8301</span><span class="symbol">:</span><span class="number">8301</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8301</span><span class="symbol">:</span><span class="number">8301</span>/udp \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8302</span><span class="symbol">:</span><span class="number">8302</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8302</span><span class="symbol">:</span><span class="number">8302</span>/udp \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8400</span><span class="symbol">:</span><span class="number">8400</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8500</span><span class="symbol">:</span><span class="number">8500</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8600</span><span class="symbol">:</span><span class="number">53</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8600</span><span class="symbol">:</span><span class="number">53</span>/udp \</span></span><br><span class="line"><span class="ruby">-v /opt/consul/<span class="symbol">data:</span>/data \</span></span><br><span class="line"><span class="ruby">-h $HOSTNAME \</span></span><br><span class="line"><span class="ruby">--restart=always \</span></span><br><span class="line"><span class="ruby">--name=consul-s1 \</span></span><br><span class="line"><span class="ruby">progrium/consul \</span></span><br><span class="line"><span class="ruby">-server -bootstrap-expect=<span class="number">1</span> \</span></span><br><span class="line"><span class="ruby">-ui-dir=<span class="regexp">/ui \</span></span></span><br><span class="line"><span class="ruby">-client <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> \</span></span><br><span class="line"><span class="ruby">-advertise <span class="number">192.168</span>.<span class="number">1.14</span></span></span><br></pre></td></tr></table></figure><h1 id="3、启动consul-server-192-168-1-15"><a href="#3、启动consul-server-192-168-1-15" class="headerlink" title="3、启动consul server 192.168.1.15"></a>3、启动consul server 192.168.1.15</h1><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">p <span class="number">8300</span><span class="symbol">:</span><span class="number">8300</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8301</span><span class="symbol">:</span><span class="number">8301</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8301</span><span class="symbol">:</span><span class="number">8301</span>/udp \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8302</span><span class="symbol">:</span><span class="number">8302</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8302</span><span class="symbol">:</span><span class="number">8302</span>/udp \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8400</span><span class="symbol">:</span><span class="number">8400</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8500</span><span class="symbol">:</span><span class="number">8500</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8600</span><span class="symbol">:</span><span class="number">53</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8600</span><span class="symbol">:</span><span class="number">53</span>/udp \</span></span><br><span class="line"><span class="ruby">-v /opt/consul/<span class="symbol">data:</span>/data \</span></span><br><span class="line"><span class="ruby">-h consul-s2 \</span></span><br><span class="line"><span class="ruby">--restart=always \</span></span><br><span class="line"><span class="ruby">--name=consul-s2 \</span></span><br><span class="line"><span class="ruby">progrium/consul \</span></span><br><span class="line"><span class="ruby">-server \</span></span><br><span class="line"><span class="ruby">-ui-dir=<span class="regexp">/ui \</span></span></span><br><span class="line"><span class="ruby">-client <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> \</span></span><br><span class="line"><span class="ruby">-advertise <span class="number">192.168</span>.<span class="number">1.15</span> -join <span class="number">192.168</span>.<span class="number">1.14</span></span></span><br></pre></td></tr></table></figure><h1 id="4、启动consul-client-192-168-1-16"><a href="#4、启动consul-client-192-168-1-16" class="headerlink" title="4、启动consul client 192.168.1.16"></a>4、启动consul client 192.168.1.16</h1><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">p <span class="number">8300</span><span class="symbol">:</span><span class="number">8300</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8301</span><span class="symbol">:</span><span class="number">8301</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8301</span><span class="symbol">:</span><span class="number">8301</span>/udp \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8302</span><span class="symbol">:</span><span class="number">8302</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8302</span><span class="symbol">:</span><span class="number">8302</span>/udp \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8400</span><span class="symbol">:</span><span class="number">8400</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8500</span><span class="symbol">:</span><span class="number">8500</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8600</span><span class="symbol">:</span><span class="number">53</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8600</span><span class="symbol">:</span><span class="number">53</span>/udp \</span></span><br><span class="line"><span class="ruby">-v /opt/consul/<span class="symbol">data:</span>/data \</span></span><br><span class="line"><span class="ruby">-h consul-c1 \</span></span><br><span class="line"><span class="ruby">--restart=always \</span></span><br><span class="line"><span class="ruby">--name=consul-c1 \</span></span><br><span class="line"><span class="ruby">progrium/consul \</span></span><br><span class="line"><span class="ruby">-advertise <span class="number">192.168</span>.<span class="number">1.16</span> -join <span class="number">192.168</span>.<span class="number">1.14</span></span></span><br></pre></td></tr></table></figure><h2 id="三、registrator状态获取"><a href="#三、registrator状态获取" class="headerlink" title="三、registrator状态获取"></a>三、registrator状态获取</h2><p>依次启动<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">-restart=always \</span></span><br><span class="line"><span class="ruby">--name=registrator \</span></span><br><span class="line"><span class="ruby">--net=host \</span></span><br><span class="line"><span class="ruby">-v /var/run/docker.<span class="symbol">sock:</span>/tmp/docker.sock \</span></span><br><span class="line"><span class="ruby">gliderlabs/registrator \</span></span><br><span class="line"><span class="ruby">-ip <span class="number">192.168</span>.<span class="number">1.14</span> \</span></span><br><span class="line"><span class="ruby"><span class="symbol">consul:</span>/<span class="regexp">/192.168.1.14:8500</span></span></span><br></pre></td></tr></table></figure></p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">-restart=always \</span></span><br><span class="line"><span class="ruby">--name=registrator \</span></span><br><span class="line"><span class="ruby">--net=host \</span></span><br><span class="line"><span class="ruby">-v /var/run/docker.<span class="symbol">sock:</span>/tmp/docker.sock \</span></span><br><span class="line"><span class="ruby">gliderlabs/registrator \</span></span><br><span class="line"><span class="ruby">-ip <span class="number">192.168</span>.<span class="number">1.15</span> \</span></span><br><span class="line"><span class="ruby"><span class="symbol">consul:</span>/<span class="regexp">/192.168.1.15:8500</span></span></span><br></pre></td></tr></table></figure><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">-restart=always \</span></span><br><span class="line"><span class="ruby">--name=registrator \</span></span><br><span class="line"><span class="ruby">--net=host \</span></span><br><span class="line"><span class="ruby">-v /var/run/docker.<span class="symbol">sock:</span>/tmp/docker.sock \</span></span><br><span class="line"><span class="ruby">gliderlabs/registrator \</span></span><br><span class="line"><span class="ruby">-ip <span class="number">192.168</span>.<span class="number">1.16</span> \</span></span><br><span class="line"><span class="ruby"><span class="symbol">consul:</span>/<span class="regexp">/192.168.1.16:8500</span></span></span><br></pre></td></tr></table></figure><h2 id="四、安装shipyard、swarm"><a href="#四、安装shipyard、swarm" class="headerlink" title="四、安装shipyard、swarm"></a>四、安装shipyard、swarm</h2><p>1、192.168.1.14<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -tid \</span><br><span class="line">-<span class="ruby">p <span class="number">3375</span><span class="symbol">:</span><span class="number">3375</span> \</span></span><br><span class="line"><span class="ruby">--restart=always \</span></span><br><span class="line"><span class="ruby">--name shipyard-swarm-manager \</span></span><br><span class="line"><span class="ruby"><span class="symbol">swarm:</span>latest \</span></span><br><span class="line"><span class="ruby">manage --host <span class="symbol">tcp:</span>/<span class="regexp">/0.0.0.0:3375 consul:/</span><span class="regexp">/192.168.1.14:8500</span></span></span><br></pre></td></tr></table></figure></p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -tid \</span><br><span class="line">-<span class="ruby">-restart=always \</span></span><br><span class="line"><span class="ruby">--name=shipyard-rethinkdb \</span></span><br><span class="line"><span class="ruby">-p <span class="number">28015</span><span class="symbol">:</span><span class="number">28015</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">29015</span><span class="symbol">:</span><span class="number">29015</span> \</span></span><br><span class="line"><span class="ruby">-v /opt/<span class="symbol">rethinkdb:</span>/data \</span></span><br><span class="line"><span class="ruby">index.tenxcloud.com/docker_library/rethinkdb</span></span><br></pre></td></tr></table></figure><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -tid \</span><br><span class="line">-<span class="ruby">-restart=always \</span></span><br><span class="line"><span class="ruby">--name shipyard-controller \</span></span><br><span class="line"><span class="ruby">--link shipyard-<span class="symbol">rethinkdb:</span>rethinkdb \</span></span><br><span class="line"><span class="ruby">--link shipyard-swarm-<span class="symbol">manager:</span>swarm \</span></span><br><span class="line"><span class="ruby">-p <span class="number">8080</span><span class="symbol">:</span><span class="number">8080</span> \</span></span><br><span class="line"><span class="ruby">dockerclub/<span class="symbol">shipyard:</span>latest \</span></span><br><span class="line"><span class="ruby">server \</span></span><br><span class="line"><span class="ruby">-d <span class="symbol">tcp:</span>/<span class="regexp">/swarm:3375</span></span></span><br></pre></td></tr></table></figure><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -tid \</span><br><span class="line"><span class="comment">--restart=always \</span></span><br><span class="line"><span class="comment">--name shipyard-swarm-agent \</span></span><br><span class="line">swarm:latest \</span><br><span class="line">join <span class="comment">--addr 192.168.1.14:2375 consul://192.168.1.14:8500</span></span><br></pre></td></tr></table></figure><h1 id="2、安装swarm-agent"><a href="#2、安装swarm-agent" class="headerlink" title="2、安装swarm-agent"></a>2、安装swarm-agent</h1><p>主机192.168.1.15操作<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -tid \</span><br><span class="line"><span class="comment">--restart=always \</span></span><br><span class="line"><span class="comment">--name shipyard-swarm-agent \</span></span><br><span class="line">swarm:latest \</span><br><span class="line">join <span class="comment">--addr 192.168.1.15:2375 consul://192.168.1.14:8500</span></span><br></pre></td></tr></table></figure></p><p>主机192.168.1.16操作<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -tid \</span><br><span class="line"><span class="comment">--restart=always \</span></span><br><span class="line"><span class="comment">--name shipyard-swarm-agent \</span></span><br><span class="line">swarm:latest \</span><br><span class="line">join <span class="comment">--addr 192.168.1.16:2375 consul://192.168.1.14:8500</span></span><br></pre></td></tr></table></figure></p><h2 id="五、安装haproxy或者nginx（192-168-1-14）"><a href="#五、安装haproxy或者nginx（192-168-1-14）" class="headerlink" title="五、安装haproxy或者nginx（192.168.1.14）"></a>五、安装haproxy或者nginx（192.168.1.14）</h2><h1 id="1、安装haproxy"><a href="#1、安装haproxy" class="headerlink" title="1、安装haproxy"></a>1、安装haproxy</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -<span class="keyword">y</span> install git patch gcc gcc-<span class="keyword">c</span>++  readline-devel zlib-devel libffi-devel \</span><br><span class="line">openssl openssl-devel <span class="keyword">make</span> autoconf automake libtool bison libxml2 \</span><br><span class="line">libxml2-devel libxslt-devel libyaml-devel  <span class="keyword">python</span>  <span class="keyword">python</span>-docutils \</span><br><span class="line">cmake imake expat-devel libaio libaio-devel bzr ncurses-devel wget \</span><br><span class="line">libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel  \</span><br><span class="line">pcre-devel curl-devel libmcrypt libmcrypt-devel</span><br><span class="line"></span><br><span class="line"><span class="keyword">cd</span> /tmp</span><br><span class="line">wget http://www.haproxy.org/download/<span class="number">1.7</span>/src/haproxy-<span class="number">1.7</span>.<span class="number">0</span>.tar.gz</span><br><span class="line">tar -xvf /tmp/haproxy-<span class="number">1.7</span>.<span class="number">0</span>.tar.gz </span><br><span class="line"><span class="keyword">make</span> TARGET=linux31 PREFIX=/<span class="keyword">opt</span>/haproxy</span><br><span class="line"><span class="keyword">make</span> install PREFIX=/<span class="keyword">opt</span>/haproxy</span><br></pre></td></tr></table></figure><h1 id="2、配置haproxy-conf"><a href="#2、配置haproxy-conf" class="headerlink" title="2、配置haproxy.conf"></a>2、配置haproxy.conf</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/haproxy/conf/haproxy.conf</span><br><span class="line">global</span><br><span class="line">                log 127.0.0.1   local0</span><br><span class="line">                #log 127.0.0.1  local1 notice</span><br><span class="line">                #log loghost    local0 info</span><br><span class="line">                maxconn 50000</span><br><span class="line">                chroot /opt/haproxy</span><br><span class="line">                uid 99</span><br><span class="line">                gid 99</span><br><span class="line"> </span><br><span class="line">                daemon</span><br><span class="line">                nbproc 2</span><br><span class="line">                pidfile /opt/haproxy/run/haproxy.pid</span><br><span class="line">                #debug</span><br><span class="line">                #quiet</span><br><span class="line"> </span><br><span class="line"> defaults</span><br><span class="line">                mode    tcp</span><br><span class="line">                option  dontlognull</span><br><span class="line">                option  forwardfor</span><br><span class="line">                option  redispatch</span><br><span class="line">                retries 2</span><br><span class="line">                balance static-rr</span><br><span class="line">                stats enable</span><br><span class="line">                stats uri /ha?stats  #haproxy运行状态查看 自定义uri</span><br><span class="line">                timeout connect     3000</span><br><span class="line">                timeout<span class="built_in"> client </span>     50000</span><br><span class="line">                timeout<span class="built_in"> server </span>50000</span><br><span class="line"> </span><br><span class="line">listen admin_stat</span><br><span class="line">        # 监听端口</span><br><span class="line">        bind *:8888</span><br><span class="line">        # http的7层模式</span><br><span class="line">        mode http</span><br><span class="line">        #log global</span><br><span class="line">        # 统计页面自动刷新时间</span><br><span class="line">        stats refresh 30s</span><br><span class="line">        # 统计页面URL</span><br><span class="line">        stats uri /admin?stats</span><br><span class="line">        # 统计页面密码框上提示文本</span><br><span class="line">        stats realm Haproxy\ Statistics</span><br><span class="line">        # 统计页面用户名和密码设置</span><br><span class="line">        stats auth admin:admin</span><br><span class="line">        # 隐藏统计页面上HAProxy的版本信息</span><br><span class="line">        #stats hide-version</span><br><span class="line"> </span><br><span class="line">listen login</span><br><span class="line">        bind *:9999</span><br><span class="line">        mode tcp</span><br><span class="line">        balance roundrobin</span><br><span class="line">        option httpchk</span><br><span class="line">        #maxconn 50000</span><br><span class="line">        #log 127.0.0.1 local0 debug</span><br></pre></td></tr></table></figure><h1 id="3、haproxy启动脚本-etc-init-d-haproxy"><a href="#3、haproxy启动脚本-etc-init-d-haproxy" class="headerlink" title="3、haproxy启动脚本 /etc/init.d/haproxy"></a>3、haproxy启动脚本 /etc/init.d/haproxy</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /bin/bash</span></span><br><span class="line"><span class="comment"># chkconfig: - 85 15</span></span><br><span class="line"><span class="comment"># description: haproxy is a World Wide Web server. It is used to serve</span></span><br><span class="line">PROGDIR=<span class="regexp">/opt/</span>haproxy</span><br><span class="line">PROGNAME=haproxy</span><br><span class="line">DAEMON=<span class="variable">$PROGDIR</span><span class="regexp">/sbin/</span><span class="variable">$PROGNAME</span></span><br><span class="line">CONFIG=<span class="variable">$PROGDIR</span><span class="regexp">/conf/</span><span class="variable">$PROGNAME</span>.conf</span><br><span class="line">PIDFILE=<span class="variable">$PROGDIR</span><span class="regexp">/run/</span><span class="variable">$PROGNAME</span>.pid</span><br><span class="line">DESC=<span class="string">"HAProxy daemon"</span></span><br><span class="line">SCRIPTNAME=<span class="regexp">/opt/</span>haproxy<span class="regexp">/init.d/</span><span class="variable">$PROGNAME</span></span><br><span class="line"><span class="comment"># Gracefully exit if the package has been removed.</span></span><br><span class="line">test -x <span class="variable">$DAEMON</span> || <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">start()</span><br><span class="line"> &#123;</span><br><span class="line">    echo -n <span class="string">"Starting $DESC: $PROGNAME"</span></span><br><span class="line">   <span class="variable">$DAEMON</span> -f <span class="variable">$CONFIG</span></span><br><span class="line">   echo <span class="string">"."</span></span><br><span class="line">        &#125;</span><br><span class="line">stop()</span><br><span class="line"> &#123;  echo -n <span class="string">"Stopping $DESC: $PROGNAME"</span></span><br><span class="line">    cat <span class="variable">$PIDFILE</span> | xargs kill</span><br><span class="line">    echo <span class="string">"."</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">reload()</span><br><span class="line"> &#123; echo -n <span class="string">"reloading $DESC: $PROGNAME"</span></span><br><span class="line">   <span class="variable">$DAEMON</span> -f <span class="variable">$CONFIG</span> -p <span class="variable">$PIDFILE</span> -sf $(cat <span class="variable">$PIDFILE</span>)</span><br><span class="line">&#125;</span><br><span class="line">case <span class="string">"$1"</span> <span class="keyword">in</span></span><br><span class="line">  start)</span><br><span class="line">  start</span><br><span class="line">  ;;</span><br><span class="line"> stop)</span><br><span class="line">  stop</span><br><span class="line">   ;;</span><br><span class="line"> reload)</span><br><span class="line"> reload</span><br><span class="line">   ;;</span><br><span class="line">*)</span><br><span class="line"> echo <span class="string">"Usage: $SCRIPTNAME &#123;start|stop|reload&#125;"</span> &gt;&amp;<span class="number">2</span></span><br><span class="line"> <span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line"> ;;</span><br><span class="line">esac</span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="4、启动haproxy-并加入到开启启动"><a href="#4、启动haproxy-并加入到开启启动" class="headerlink" title="4、启动haproxy,并加入到开启启动"></a>4、启动haproxy,并加入到开启启动</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/init.d/haproxy</span><br><span class="line">chkconfig haproxy op</span><br><span class="line">service haproxy start</span><br></pre></td></tr></table></figure><h1 id="5、安装nginx-并支持数字证书"><a href="#5、安装nginx-并支持数字证书" class="headerlink" title="5、安装nginx 并支持数字证书"></a>5、安装nginx 并支持数字证书</h1><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install git patch gcc gcc-c++  readline-devel zlib-devel libffi-devel <span class="string">\</span></span><br><span class="line"> openssl openssl-devel make autoconf automake libtool bison libxml2 <span class="string">\</span></span><br><span class="line"> libxml2-devel libxslt-devel libyaml-devel  python  python-docutils <span class="string">\</span></span><br><span class="line"> cmake imake expat-devel libaio libaio-devel bzr ncurses-devel wget <span class="string">\</span></span><br><span class="line"> libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel  <span class="string">\</span></span><br><span class="line"> pcre-devel curl-devel libmcrypt libmcrypt-devel</span><br></pre></td></tr></table></figure><h1 id="6、下载安装openssl"><a href="#6、下载安装openssl" class="headerlink" title="6、下载安装openssl"></a>6、下载安装openssl</h1><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">cd</span> <span class="string">/tmp</span></span><br><span class="line">wget https:<span class="string">//www.openssl.org/source/openssl-1.1.0c.tar.gz</span></span><br><span class="line"> tar -xvf openssl-1.1.0c.tar.gz</span><br><span class="line"> <span class="keyword">cd</span> <span class="string">/tmp/openssl-1.1.0c</span></span><br><span class="line"><span class="string">./config</span>   <span class="params">--openssldir=/usr/local/ssl</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="string">./config</span> shared  <span class="params">--openssldir=/usr/local/ssl</span></span><br><span class="line">make clean</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h1 id="7、下载安装-nginx"><a href="#7、下载安装-nginx" class="headerlink" title="7、下载安装 nginx"></a>7、下载安装 nginx</h1><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">wget http://nginx.org/download/nginx-1.11.7.tar.gz</span><br><span class="line">groupadd -r nginx</span><br><span class="line">useradd -g nginx -r nginx -s /bin/false</span><br><span class="line">tar -xvf nginx-1.11.7.tar.gz</span><br><span class="line">cd /tmp/nginx-1.11.7</span><br><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">-<span class="ruby">-sbin-path=<span class="regexp">/usr/sbin</span><span class="regexp">/nginx \</span></span></span><br><span class="line"><span class="ruby">--conf-path=<span class="regexp">/etc/nginx</span><span class="regexp">/nginx.conf \</span></span></span><br><span class="line"><span class="ruby">--error-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/error</span>.log \</span></span><br><span class="line"><span class="ruby">--http-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/access</span>.log \</span></span><br><span class="line"><span class="ruby">--pid-path=<span class="regexp">/var/run</span><span class="regexp">/nginx.pid \</span></span></span><br><span class="line"><span class="ruby">--lock-path=<span class="regexp">/var/run</span><span class="regexp">/nginx.lock \</span></span></span><br><span class="line"><span class="ruby">--http-client-body-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/client</span>_temp \</span></span><br><span class="line"><span class="ruby">--http-proxy-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/proxy</span>_temp \</span></span><br><span class="line"><span class="ruby">--http-fastcgi-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/fastcgi</span>_temp \</span></span><br><span class="line"><span class="ruby">--http-uwsgi-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/uwsgi</span>_temp \</span></span><br><span class="line"><span class="ruby">--http-scgi-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/scgi</span>_temp \</span></span><br><span class="line"><span class="ruby">--user=nginx \</span></span><br><span class="line"><span class="ruby">--group=nginx \</span></span><br><span class="line"><span class="ruby">--with-http_ssl_module \</span></span><br><span class="line"><span class="ruby">--with-http_realip_module \</span></span><br><span class="line"><span class="ruby">--with-http_addition_module \</span></span><br><span class="line"><span class="ruby">--with-http_sub_module \</span></span><br><span class="line"><span class="ruby">--with-http_dav_module \</span></span><br><span class="line"><span class="ruby">--with-http_flv_module \</span></span><br><span class="line"><span class="ruby">--with-http_mp4_module \</span></span><br><span class="line"><span class="ruby">--with-http_gunzip_module \</span></span><br><span class="line"><span class="ruby">--with-http_gzip_static_module \</span></span><br><span class="line"><span class="ruby">--with-http_random_index_module \</span></span><br><span class="line"><span class="ruby">--with-http_secure_link_module \</span></span><br><span class="line"><span class="ruby">--with-http_stub_status_module \</span></span><br><span class="line"><span class="ruby">--with-http_auth_request_module \</span></span><br><span class="line"><span class="ruby">--with-threads \</span></span><br><span class="line"><span class="ruby">--with-stream \</span></span><br><span class="line"><span class="ruby">--with-openssl=<span class="regexp">/tmp/openssl</span>-<span class="number">1.1</span>.0c \</span></span><br><span class="line"><span class="ruby">--with-stream_ssl_module \</span></span><br><span class="line"><span class="ruby">--with-http_slice_module \</span></span><br><span class="line"><span class="ruby">--with-mail \</span></span><br><span class="line"><span class="ruby">--with-mail_ssl_module \</span></span><br><span class="line"><span class="ruby">--with-file-aio \</span></span><br><span class="line"><span class="ruby">--with-http_v2_module \</span></span><br><span class="line"><span class="ruby">--with-ipv6 </span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">mkdir -pv /var/cache/nginx/&#123;client_temp,proxy_temp,fastcgi_temp,uwsgi_temp,scgi_temp&#125;</span></span><br><span class="line"><span class="ruby">mkdir -p /etc/nginx/conf.d</span></span><br><span class="line"><span class="ruby">make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h1 id="8、nginx配置文件"><a href="#8、nginx配置文件" class="headerlink" title="8、nginx配置文件"></a>8、nginx配置文件</h1><p>修改/etc/nginx/nginx.conf<br>user  nginx;<br>worker_processes  1;</p><p>error_log  /var/log/nginx/error.log warn;<br>pid        /var/run/nginx.pid;</p><p>events {<br>    worker_connections  1024;<br>}</p><p>http {<br>    include       /etc/nginx/mime.types;<br>    default_type  application/octet-stream;</p><pre><code>log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;access_log  /var/log/nginx/access.log  main;sendfile        on;tcp_nopush     on;keepalive_timeout  65;gzip  on;include /etc/nginx/conf.d/*.conf;</code></pre><p>}</p><p>添加nginx默认web配置文件<br>/etc/nginx/conf.d/default.conf<br>server {<br>        listen       80;<br>        server_name  localhost;</p><pre><code>#charset koi8-r;#access_log  logs/host.access.log  main;location / {    root   /usr/local/nginx/html;    index  index.php index.html index.htm;}#error_page  404              /404.html;# redirect server error pages to the static page /50x.html#error_page   500 502 503 504  /50x.html;location = /50x.html {    root   html;}# proxy the PHP scripts to Apache listening on 127.0.0.1:80##location ~ \.php$ {#    proxy_pass   http://127.0.0.1;#}# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000#location ~ \.php$ {    root           /usr/local/nginx/html;    fastcgi_pass   127.0.0.1:9000;    fastcgi_index  index.php;    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;    include        fastcgi_params;}location ~* ^.+\.(jpg|jpeg|gif|png|bmp)$ {    access_log  off;    root        opencart;    expires     30d;                break;}</code></pre><p>}</p><h1 id="9、创建nginx启动脚本-etc-init-d-nginx"><a href="#9、创建nginx启动脚本-etc-init-d-nginx" class="headerlink" title="9、创建nginx启动脚本 /etc/init.d/nginx"></a>9、创建nginx启动脚本 /etc/init.d/nginx</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chkconfig: 2345 10 90</span></span><br><span class="line"><span class="comment"># description: Start and Stop redis</span></span><br><span class="line"> </span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/bin:/sbin:/usr/bin:/bin</span><br><span class="line"> </span><br><span class="line">EXEC=/usr/sbin/nginx</span><br><span class="line">PIDFILE=/var/run/nginx.pid</span><br><span class="line">CONF=<span class="string">"/etc/nginx/nginx.conf"</span></span><br><span class="line">AUTH=<span class="string">"1234"</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">        start)</span><br><span class="line">                <span class="keyword">if</span> [ -f <span class="variable">$PIDFILE</span> ]</span><br><span class="line">                <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"<span class="variable">$PIDFILE</span> exists, process is already running or crashed."</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"Starting nginx server..."</span></span><br><span class="line">                        <span class="variable">$EXEC</span> &amp;</span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                <span class="keyword">if</span> [ <span class="string">"$?"</span>=<span class="string">"0"</span> ]</span><br><span class="line">                <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"nginx is running..."</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                ;;</span><br><span class="line">        stop)</span><br><span class="line">                <span class="keyword">if</span> [ ! -f <span class="variable">$PIDFILE</span> ]</span><br><span class="line">                <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"<span class="variable">$PIDFILE</span> exists, process is not running."</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        PID=$(cat <span class="variable">$PIDFILE</span>)</span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"Stopping..."</span></span><br><span class="line">                        <span class="built_in">kill</span> -9 <span class="variable">$PID</span></span><br><span class="line">                        PID=$(pidof nginx)</span><br><span class="line">                        <span class="built_in">kill</span> -9 <span class="variable">$PID</span></span><br><span class="line">                        rm -rf /var/run/nginx.pid</span><br><span class="line">                        sleep 2</span><br><span class="line">                       <span class="keyword">while</span> [ -x <span class="variable">$PIDFILE</span> ]</span><br><span class="line">                       <span class="keyword">do</span></span><br><span class="line">                                <span class="built_in">echo</span> <span class="string">"Waiting for nginx to shutdown..."</span></span><br><span class="line">                               sleep 1</span><br><span class="line">                        <span class="keyword">done</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"nginx stopped"</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                ;;</span><br><span class="line">        restart|reload)</span><br><span class="line">                <span class="variable">$&#123;0&#125;</span> stop</span><br><span class="line">                <span class="variable">$&#123;0&#125;</span> start</span><br><span class="line">                ;;</span><br><span class="line">        *)</span><br><span class="line">               <span class="built_in">echo</span> <span class="string">"Usage: /etc/init.d/nginx &#123;start|stop|restart|reload&#125;"</span> &gt;&amp;2</span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><h1 id="10、设置nginx开机启动"><a href="#10、设置nginx开机启动" class="headerlink" title="10、设置nginx开机启动"></a>10、设置nginx开机启动</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/init.d/nginx</span><br><span class="line">chkconfig nginx on</span><br><span class="line">service nginx start</span><br></pre></td></tr></table></figure><h2 id="六、安装consul-template-实现服务自动发现"><a href="#六、安装consul-template-实现服务自动发现" class="headerlink" title="六、安装consul-template 实现服务自动发现"></a>六、安装consul-template 实现服务自动发现</h2><h1 id="1、下载consul-template"><a href="#1、下载consul-template" class="headerlink" title="1、下载consul-template"></a>1、下载consul-template</h1><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="string">/tmp</span></span><br><span class="line">wget https:<span class="string">//releases.hashicorp.com/consul-template/0.16.0/consul-template_0.16.0_linux_amd64.zip</span></span><br><span class="line">yum -y install unzip</span><br><span class="line">unzip <span class="string">/tmp/consul-template_0.16.0_linux_amd64.zip</span> -d <span class="string">/usr/bin/</span></span><br></pre></td></tr></table></figure><h1 id="2、consul-template-haproxy配置"><a href="#2、consul-template-haproxy配置" class="headerlink" title="2、consul-template haproxy配置"></a>2、consul-template haproxy配置</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/consul/conf/haproxy_ctmpl.json &lt;&lt; EOF</span><br><span class="line">consul = <span class="string">"127.0.0.1:8500"</span></span><br><span class="line">   </span><br><span class="line">template &#123;</span><br><span class="line">  source = <span class="string">"/opt/haproxy/conf/haproxy.ctmpl"</span></span><br><span class="line">  destination = <span class="string">"/opt/haproxy/conf/haproxy.conf"</span></span><br><span class="line">  command = <span class="string">"/etc/init.d/haproxy reload"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">3、haproxy.ctmpl配置 /opt/haproxy/conf/haproxy.ctmpl</span><br><span class="line">global  </span><br><span class="line">                log 127.0.0.1   local0  </span><br><span class="line">                #log 127.0.0.1  local1 notice  </span><br><span class="line">                #log loghost    local0 <span class="builtin-name">info</span>  </span><br><span class="line">                maxconn 50000  </span><br><span class="line">                chroot /opt/haproxy</span><br><span class="line">                uid 99  </span><br><span class="line">                gid 99 </span><br><span class="line"> </span><br><span class="line">                daemon  </span><br><span class="line">                nbproc 2</span><br><span class="line">                pidfile /opt/haproxy/run/haproxy.pid  </span><br><span class="line">                #<span class="builtin-name">debug</span>  </span><br><span class="line">                #quiet  </span><br><span class="line">    </span><br><span class="line"> defaults  </span><br><span class="line">                mode    tcp  </span><br><span class="line">                option  dontlognull  </span><br><span class="line">                option  forwardfor  </span><br><span class="line">                option  redispatch  </span><br><span class="line">                retries 2  </span><br><span class="line">                balance static-rr</span><br><span class="line">                stats enable</span><br><span class="line">                stats uri /ha?stats </span><br><span class="line">                timeout connect     3000  </span><br><span class="line">                timeout<span class="built_in"> client </span>     50000  </span><br><span class="line">                timeout<span class="built_in"> server </span>50000  </span><br><span class="line"></span><br><span class="line">listen admin_stat  </span><br><span class="line">        bind *:8888    </span><br><span class="line">        mode http  </span><br><span class="line">        #log global   </span><br><span class="line">        stats refresh 30s  </span><br><span class="line">        stats uri /admin?stats  </span><br><span class="line">        stats realm Haproxy\ Statistics </span><br><span class="line">        stats auth admin:admin </span><br><span class="line">        #stats hide-version  </span><br><span class="line"> </span><br><span class="line">frontend www</span><br><span class="line">         bind *:80</span><br><span class="line">         mode http</span><br><span class="line">         acl apache  hdr(HOST) apache.zone.com</span><br><span class="line">         acl nginx   hdr(HOST) nginx.zone.com</span><br><span class="line">         use_backend apache.qkazone.com <span class="keyword">if</span> apache</span><br><span class="line">         use_backend nginx.qkazone.com <span class="keyword">if</span> nginx</span><br><span class="line">backend apache.zone.com</span><br><span class="line">        balance         roundrobin</span><br><span class="line">        mode            http</span><br><span class="line">&#123;&#123;range<span class="built_in"> service </span><span class="string">"apache-php-80"</span>&#125;&#125;</span><br><span class="line">       <span class="built_in"> server </span> apache &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; check &#123;&#123;end&#125;&#125;</span><br><span class="line"> </span><br><span class="line">backend nginx.zone.com</span><br><span class="line">        mode http</span><br><span class="line">        balance         roundrobin</span><br><span class="line">&#123;&#123;range<span class="built_in"> service </span><span class="string">"nginx-80"</span>&#125;&#125;</span><br><span class="line">       <span class="built_in"> server </span> nginx &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; check &#123;&#123;end&#125;&#125;</span><br><span class="line"> </span><br><span class="line">listen login</span><br><span class="line">        bind *:9999</span><br><span class="line">        mode tcp</span><br><span class="line">        balance roundrobin</span><br><span class="line">        #log 127.0.0.1 local0 debug</span><br><span class="line">        &#123;&#123;range<span class="built_in"> service </span><span class="string">"centos7"</span>&#125;&#125;</span><br><span class="line">       <span class="built_in"> server </span> ssh &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; check &#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure><h1 id="4、配置consul-template-haproxy-启动脚本-etc-init-d-haproxy-ctmpl"><a href="#4、配置consul-template-haproxy-启动脚本-etc-init-d-haproxy-ctmpl" class="headerlink" title="4、配置consul-template  haproxy 启动脚本 /etc/init.d/haproxy_ctmpl"></a>4、配置consul-template  haproxy 启动脚本 /etc/init.d/haproxy_ctmpl</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 10 90</span></span><br><span class="line"><span class="comment"># description: Start and Stop redis</span></span><br><span class="line"> </span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/bin:/sbin:/usr/bin:/bin</span><br><span class="line">EXEC=/usr/bin/consul-template</span><br><span class="line">CONF=<span class="string">"/opt/consul/conf/haproxy_ctmpl.json"</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">        start)</span><br><span class="line">                 PID=$(ps -ef | grep -v grep  | grep <span class="string">"<span class="variable">$EXEC</span> -config <span class="variable">$CONF</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">               <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$PID</span>"</span>   ]</span><br><span class="line">                   <span class="keyword">then</span></span><br><span class="line">                     <span class="built_in">echo</span> <span class="string">"haproxy_ctmpl is running..."</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Starting haproxy_ctmpl server..."</span></span><br><span class="line">                        <span class="variable">$EXEC</span> -config <span class="variable">$CONF</span> &gt; /tmp/haproxy_ctmpl.out 2&gt;&amp;1 &amp;</span><br><span class="line">             <span class="keyword">fi</span></span><br><span class="line">             ;;</span><br><span class="line">       stop)</span><br><span class="line">            PID=$(ps -ef | grep -v grep  | grep <span class="string">"<span class="variable">$EXEC</span> -config <span class="variable">$CONF</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">            <span class="keyword">if</span> [  -n <span class="string">"<span class="variable">$PID</span>"</span> ]</span><br><span class="line">                 <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"Stopping..."</span></span><br><span class="line">                        <span class="built_in">kill</span> -9 <span class="variable">$PID</span></span><br><span class="line">                        sleep 2</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">echo</span> <span class="string">"haproxy_ctmpl exists, process is not running."</span></span><br><span class="line">             <span class="keyword">fi</span></span><br><span class="line">             ;;</span><br><span class="line">       restart|force-reload)</span><br><span class="line">                <span class="variable">$&#123;0&#125;</span> stop</span><br><span class="line">                <span class="variable">$&#123;0&#125;</span> start</span><br><span class="line">                ;;</span><br><span class="line">*)</span><br><span class="line">               <span class="built_in">echo</span> <span class="string">"Usage: /etc/init.d/tmpl &#123;start|stop|restart|force-reload&#125;"</span> &gt;&amp;2</span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><h1 id="5、设置开机启动，启动"><a href="#5、设置开机启动，启动" class="headerlink" title="5、设置开机启动，启动"></a>5、设置开机启动，启动</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/init.d/haproxy_ctmpl</span><br><span class="line">chkconfig haproxy_ctmpl on</span><br><span class="line">service haproxy_ctmpl start</span><br></pre></td></tr></table></figure><h1 id="6、consul-template-nginx配置-opt-consul-conf-nginx-ctmpl-json"><a href="#6、consul-template-nginx配置-opt-consul-conf-nginx-ctmpl-json" class="headerlink" title="6、consul-template  nginx配置 /opt/consul/conf/nginx_ctmpl.json"></a>6、consul-template  nginx配置 /opt/consul/conf/nginx_ctmpl.json</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> &gt; /<span class="keyword">opt</span>/consul/<span class="keyword">conf</span>/nginx_ctmpl.json &lt;&lt; EOF</span><br><span class="line">consul = <span class="string">"127.0.0.1:8500"</span></span><br><span class="line">   </span><br><span class="line">template &#123;</span><br><span class="line">  <span class="keyword">source</span> = <span class="string">"/etc/nginx/conf.d/nginx_web.ctmpl"</span></span><br><span class="line">  destination = <span class="string">"/etc/nginx/conf.d/nginx_web.conf"</span></span><br><span class="line">  <span class="keyword">command</span> = <span class="string">"/usr/sbin/nginx  -s reload"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="7、-etc-nginx-conf-d-nginx-web-ctmpl-配置"><a href="#7、-etc-nginx-conf-d-nginx-web-ctmpl-配置" class="headerlink" title="7、/etc/nginx/conf.d/nginx_web.ctmpl 配置"></a>7、/etc/nginx/conf.d/nginx_web.ctmpl 配置</h1><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">upstream apache &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    # Refer: http://nginx.org/en/docs/http/ngx_http_upstream_module.html#upstream</span><br><span class="line">    # least_conn;</span><br><span class="line">    # least_time;</span><br><span class="line">&#123;&#123;range service <span class="string">"apache-php-80"</span>&#125;&#125;</span><br><span class="line">    server &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; fail_timeout=<span class="number">0</span>;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">    keepalive <span class="number">64</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name apache.zone.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        client_max_body_size    <span class="number">0</span>;</span><br><span class="line">        proxy_connect_timeout <span class="number">300</span>s;</span><br><span class="line">        proxy_send_timeout   <span class="number">900</span>;</span><br><span class="line">        proxy_read_timeout   <span class="number">900</span>;</span><br><span class="line">        proxy_buffer_size    <span class="number">32</span>k;</span><br><span class="line">        proxy_buffers      <span class="number">4</span> <span class="number">32</span>k;</span><br><span class="line">        proxy_busy_buffers_size <span class="number">64</span>k;</span><br><span class="line">        proxy_redirect     off;</span><br><span class="line">        proxy_hide_header  Vary;</span><br><span class="line">        proxy_set_header   Accept-Encoding <span class="string">''</span>;</span><br><span class="line">        proxy_set_header   Host   $host;</span><br><span class="line">        proxy_set_header   Referer $http_referer;</span><br><span class="line">        proxy_set_header   Cookie $http_cookie;</span><br><span class="line">        proxy_set_header   X-Real-IP  $remote_addr;</span><br><span class="line">        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header   Host $host;</span><br><span class="line">        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_headers_hash_max_size <span class="number">51200</span>;</span><br><span class="line">        proxy_headers_hash_bucket_size <span class="number">6400</span>;</span><br><span class="line">        proxy_pass          http://apache/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">upstream nginx &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    # Refer: http://nginx.org/en/docs/http/ngx_http_upstream_module.html#upstream</span><br><span class="line">    # least_conn;</span><br><span class="line">    # least_time;</span><br><span class="line">&#123;&#123;range service <span class="string">"nginx-80"</span>&#125;&#125;</span><br><span class="line">    server &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; fail_timeout=<span class="number">0</span>;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">    keepalive <span class="number">64</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name nginx.zone.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        client_max_body_size    <span class="number">0</span>;</span><br><span class="line">        proxy_connect_timeout <span class="number">300</span>s;</span><br><span class="line">        proxy_send_timeout   <span class="number">900</span>;</span><br><span class="line">        proxy_read_timeout   <span class="number">900</span>;</span><br><span class="line">        proxy_buffer_size    <span class="number">32</span>k;</span><br><span class="line">        proxy_buffers      <span class="number">4</span> <span class="number">32</span>k;</span><br><span class="line">        proxy_busy_buffers_size <span class="number">64</span>k;</span><br><span class="line">        proxy_redirect     off;</span><br><span class="line">        proxy_hide_header  Vary;</span><br><span class="line">        proxy_set_header   Accept-Encoding <span class="string">''</span>;</span><br><span class="line">        proxy_set_header   Host   $host;</span><br><span class="line">        proxy_set_header   Referer $http_referer;</span><br><span class="line">        proxy_set_header   Cookie $http_cookie;</span><br><span class="line">        proxy_set_header   X-Real-IP  $remote_addr;</span><br><span class="line">        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header   Host $host;</span><br><span class="line">        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_headers_hash_max_size <span class="number">51200</span>;</span><br><span class="line">        proxy_headers_hash_bucket_size <span class="number">6400</span>;</span><br><span class="line">        proxy_pass          http://nginx/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="8、配置consul-template-nginx启动脚本-etc-init-d-nginx-ctmpl"><a href="#8、配置consul-template-nginx启动脚本-etc-init-d-nginx-ctmpl" class="headerlink" title="8、配置consul-template  nginx启动脚本 /etc/init.d/nginx_ctmpl"></a>8、配置consul-template  nginx启动脚本 /etc/init.d/nginx_ctmpl</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 10 90</span></span><br><span class="line"><span class="comment"># description: Start and Stop redis</span></span><br><span class="line"></span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/bin:/sbin:/usr/bin:/bin</span><br><span class="line">EXEC=/usr/bin/consul-template</span><br><span class="line">CONF=<span class="string">"/opt/consul/conf/nginx_ctmpl.json"</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">        start)</span><br><span class="line">                 PID=$(ps -ef | grep -v grep  | grep <span class="string">"<span class="variable">$EXEC</span> -config <span class="variable">$CONF</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">               <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$PID</span>"</span>   ]</span><br><span class="line">                   <span class="keyword">then</span></span><br><span class="line">                     <span class="built_in">echo</span> <span class="string">"haproxy_ctmpl is running..."</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Starting haproxy_ctmpl server..."</span></span><br><span class="line">                        <span class="variable">$EXEC</span> -config <span class="variable">$CONF</span> &gt; /tmp/nginx_ctmpl.out 2&gt;&amp;1 &amp;</span><br><span class="line">             <span class="keyword">fi</span></span><br><span class="line">             ;;</span><br><span class="line">       stop)</span><br><span class="line">            PID=$(ps -ef | grep -v grep  | grep <span class="string">"<span class="variable">$EXEC</span> -config <span class="variable">$CONF</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">            <span class="keyword">if</span> [  -n <span class="string">"<span class="variable">$PID</span>"</span> ]</span><br><span class="line">                 <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"Stopping..."</span></span><br><span class="line">                        <span class="built_in">kill</span> -9 <span class="variable">$PID</span></span><br><span class="line">                        sleep 2</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">echo</span> <span class="string">"haproxy_ctmpl exists, process is not running."</span></span><br><span class="line">             <span class="keyword">fi</span></span><br><span class="line">             ;;</span><br><span class="line">       restart|force-reload)</span><br><span class="line">                <span class="variable">$&#123;0&#125;</span> stop</span><br><span class="line">                <span class="variable">$&#123;0&#125;</span> start</span><br><span class="line">                ;;</span><br><span class="line">*)</span><br><span class="line">               <span class="built_in">echo</span> <span class="string">"Usage: /etc/init.d/tmpl &#123;start|stop|restart|force-reload&#125;"</span> &gt;&amp;2</span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><h1 id="9、设置开机启动"><a href="#9、设置开机启动" class="headerlink" title="9、设置开机启动"></a>9、设置开机启动</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/init.d/nginx_ctmpl</span><br><span class="line">chkconfig nginx_ctmpl on</span><br><span class="line">service nginx_ctmpl start</span><br></pre></td></tr></table></figure><h2 id="七、测试是否自动发现"><a href="#七、测试是否自动发现" class="headerlink" title="七、测试是否自动发现"></a>七、测试是否自动发现</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="bash"> -ti -d -p :80 eboraas/apache-php </span></span><br><span class="line"><span class="bash">docker run -d -ti -p :80 nginx</span></span><br></pre></td></tr></table></figure><p>1、consul web<br><a href="http://192.168.1.66:8500/ui/#/dc1/services" target="_blank" rel="noopener">http://192.168.1.66:8500/ui/#/dc1/services</a></p><p>2、shipyard web<br><a href="http://192.168.1.23:8080" target="_blank" rel="noopener">http://192.168.1.23:8080</a><br>账号admin密码 shipyard</p><p>3、haproxy web<br><a href="http://192.168.1.14:8888/admin?stats" target="_blank" rel="noopener">http://192.168.1.14:8888/admin?stats</a><br>账号：admin 密码admin<br><code>`</code></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;docker-swarm集群&quot;&gt;&lt;a href=&quot;#docker-swarm集群&quot; class=&quot;headerlink&quot; title=&quot;docker swarm集群&quot;&gt;&lt;/a&gt;docker swarm集群&lt;/h1&gt;
    
    </summary>
    
      <category term="Docker" scheme="http://ippai.top/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://ippai.top/tags/Docker/"/>
    
      <category term="linux自动化运维" scheme="http://ippai.top/tags/linux%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>docker-redis集群</title>
    <link href="http://ippai.top/2018/04/08/docker-redis%E9%9B%86%E7%BE%A4/"/>
    <id>http://ippai.top/2018/04/08/docker-redis集群/</id>
    <published>2018-04-08T03:16:46.000Z</published>
    <updated>2018-04-08T12:15:42.033Z</updated>
    
    <content type="html"><![CDATA[<p>基于docker搭建redis集群方案<br><a id="more"></a><br>master    192.168.1.14<br>slave    192.168.1.15</p><h2 id="master操作"><a href="#master操作" class="headerlink" title="master操作"></a>master操作</h2><h1 id="1-创建数据文件"><a href="#1-创建数据文件" class="headerlink" title="1.创建数据文件"></a>1.创建数据文件</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /<span class="keyword">opt</span>/redis</span><br></pre></td></tr></table></figure><h1 id="2-拉取redis镜像"><a href="#2-拉取redis镜像" class="headerlink" title="2.拉取redis镜像"></a>2.拉取redis镜像</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull benyoo/<span class="keyword">redi</span><span class="variable">s:3</span>.<span class="number">2.5</span></span><br></pre></td></tr></table></figure><h1 id="3-配置redis文件"><a href="#3-配置redis文件" class="headerlink" title="3.配置redis文件"></a>3.配置redis文件</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">echo 'bind 0.0.0.0</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize no</span><br><span class="line">supervised no</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile ""</span><br><span class="line">databases 8</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="keyword">stop</span>-writes-<span class="keyword">on</span>-bgsave-<span class="keyword">error</span> yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /<span class="keyword">data</span>/redis</span><br><span class="line"><span class="keyword">slave</span>-serve-stale-<span class="keyword">data</span> yes</span><br><span class="line"><span class="keyword">slave</span>-<span class="keyword">read</span>-<span class="keyword">only</span> yes</span><br><span class="line">repl-diskless-<span class="keyword">sync</span> <span class="keyword">no</span></span><br><span class="line">repl-diskless-<span class="keyword">sync</span>-delay <span class="number">5</span></span><br><span class="line">repl-<span class="keyword">disable</span>-tcp-<span class="keyword">nodelay</span> <span class="keyword">no</span></span><br><span class="line"><span class="keyword">slave</span>-<span class="keyword">priority</span> <span class="number">100</span></span><br><span class="line">appendonly <span class="keyword">no</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="keyword">no</span>-appendfsync-<span class="keyword">on</span>-rewrite <span class="keyword">no</span></span><br><span class="line"><span class="keyword">auto</span>-aof-rewrite-percentage <span class="number">100</span></span><br><span class="line"><span class="keyword">auto</span>-aof-rewrite-<span class="keyword">min</span>-<span class="keyword">size</span> <span class="number">64</span>mb</span><br><span class="line">aof-<span class="keyword">load</span>-truncated yes</span><br><span class="line">lua-<span class="keyword">time</span>-<span class="keyword">limit</span> <span class="number">5000</span></span><br><span class="line">slowlog-<span class="keyword">log</span>-slower-<span class="keyword">than</span> <span class="number">10000</span></span><br><span class="line">slowlog-<span class="keyword">max</span>-<span class="keyword">len</span> <span class="number">128</span></span><br><span class="line">latency-monitor-threshold <span class="number">0</span></span><br><span class="line">notify-keyspace-<span class="keyword">events</span> <span class="string">""</span></span><br><span class="line"><span class="keyword">hash</span>-<span class="keyword">max</span>-ziplist-entries <span class="number">512</span></span><br><span class="line"><span class="keyword">hash</span>-<span class="keyword">max</span>-ziplist-<span class="keyword">value</span> <span class="number">64</span></span><br><span class="line"><span class="keyword">list</span>-<span class="keyword">max</span>-ziplist-<span class="keyword">size</span> <span class="number">-2</span></span><br><span class="line"><span class="keyword">list</span>-<span class="keyword">compress</span>-<span class="keyword">depth</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">set</span>-<span class="keyword">max</span>-intset-entries <span class="number">512</span></span><br><span class="line">zset-<span class="keyword">max</span>-ziplist-entries <span class="number">128</span></span><br><span class="line">zset-<span class="keyword">max</span>-ziplist-<span class="keyword">value</span> <span class="number">64</span></span><br><span class="line">hll-<span class="keyword">sparse</span>-<span class="keyword">max</span>-<span class="keyword">bytes</span> <span class="number">3000</span></span><br><span class="line">activerehashing yes</span><br><span class="line"><span class="keyword">client</span>-<span class="keyword">output</span>-buffer-<span class="keyword">limit</span> <span class="keyword">normal</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">client</span>-<span class="keyword">output</span>-buffer-<span class="keyword">limit</span> <span class="keyword">slave</span> <span class="number">256</span>mb <span class="number">64</span>mb <span class="number">60</span></span><br><span class="line"><span class="keyword">client</span>-<span class="keyword">output</span>-buffer-<span class="keyword">limit</span> pubsub <span class="number">32</span>mb <span class="number">8</span>mb <span class="number">60</span></span><br><span class="line">hz <span class="number">10</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line"> </span><br><span class="line">masterauth ZDU0NTlkNDY5NWZi</span><br><span class="line">requirepass ZDU0NTlkNDY5NWZi<span class="string">' &gt;/opt/redis/redis.conf</span></span><br></pre></td></tr></table></figure><h1 id="4-配置防火墙"><a href="#4-配置防火墙" class="headerlink" title="4.配置防火墙"></a>4.配置防火墙</h1><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT <span class="number">5</span> -p tcp -m <span class="keyword">state</span> --state NEW -m tcp -m comment --comment <span class="string">"REDIS_SERVER"</span> -m multiport --dports <span class="number">6379</span> -j ACCEPT</span><br><span class="line">iptables -nvxL --lin</span><br></pre></td></tr></table></figure><h1 id="5-启动redis容器"><a href="#5-启动redis容器" class="headerlink" title="5.启动redis容器"></a>5.启动redis容器</h1><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">-privileged=<span class="literal">true</span> \</span></span><br><span class="line"><span class="ruby">--name redis-master \</span></span><br><span class="line"><span class="ruby">--restart=always \</span></span><br><span class="line"><span class="ruby">-p <span class="number">6379</span><span class="symbol">:</span><span class="number">6379</span></span></span><br><span class="line"><span class="ruby">-v /opt/redis/redis.<span class="symbol">conf:</span>/etc/redis.conf \</span></span><br><span class="line"><span class="ruby">-v /etc/<span class="symbol">localtime:</span>/etc/localtime \</span></span><br><span class="line"><span class="ruby">benyoo/<span class="symbol">redis:</span><span class="number">3.2</span>.<span class="number">5</span></span></span><br></pre></td></tr></table></figure><h2 id="slave上操作"><a href="#slave上操作" class="headerlink" title="slave上操作"></a>slave上操作</h2><h1 id="1-创建数据文件-1"><a href="#1-创建数据文件-1" class="headerlink" title="1.创建数据文件"></a>1.创建数据文件</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /<span class="keyword">opt</span>/redis</span><br></pre></td></tr></table></figure><p>2.拉取redis镜像<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull benyoo/<span class="keyword">redi</span><span class="variable">s:3</span>.<span class="number">2.5</span></span><br></pre></td></tr></table></figure></p><p>3.配置redis文件<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">echo 'bind 0.0.0.0</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize no</span><br><span class="line">supervised no</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile ""</span><br><span class="line">databases 8</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="keyword">stop</span>-writes-<span class="keyword">on</span>-bgsave-<span class="keyword">error</span> yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /<span class="keyword">data</span>/redis</span><br><span class="line"><span class="keyword">slave</span>-serve-stale-<span class="keyword">data</span> yes</span><br><span class="line"><span class="keyword">slave</span>-<span class="keyword">read</span>-<span class="keyword">only</span> yes</span><br><span class="line">repl-diskless-<span class="keyword">sync</span> <span class="keyword">no</span></span><br><span class="line">repl-diskless-<span class="keyword">sync</span>-delay <span class="number">5</span></span><br><span class="line">repl-<span class="keyword">disable</span>-tcp-<span class="keyword">nodelay</span> <span class="keyword">no</span></span><br><span class="line"><span class="keyword">slave</span>-<span class="keyword">priority</span> <span class="number">100</span></span><br><span class="line">appendonly <span class="keyword">no</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="keyword">no</span>-appendfsync-<span class="keyword">on</span>-rewrite <span class="keyword">no</span></span><br><span class="line"><span class="keyword">auto</span>-aof-rewrite-percentage <span class="number">100</span></span><br><span class="line"><span class="keyword">auto</span>-aof-rewrite-<span class="keyword">min</span>-<span class="keyword">size</span> <span class="number">64</span>mb</span><br><span class="line">aof-<span class="keyword">load</span>-truncated yes</span><br><span class="line">lua-<span class="keyword">time</span>-<span class="keyword">limit</span> <span class="number">5000</span></span><br><span class="line">slowlog-<span class="keyword">log</span>-slower-<span class="keyword">than</span> <span class="number">10000</span></span><br><span class="line">slowlog-<span class="keyword">max</span>-<span class="keyword">len</span> <span class="number">128</span></span><br><span class="line">latency-monitor-threshold <span class="number">0</span></span><br><span class="line">notify-keyspace-<span class="keyword">events</span> <span class="string">""</span></span><br><span class="line"><span class="keyword">hash</span>-<span class="keyword">max</span>-ziplist-entries <span class="number">512</span></span><br><span class="line"><span class="keyword">hash</span>-<span class="keyword">max</span>-ziplist-<span class="keyword">value</span> <span class="number">64</span></span><br><span class="line"><span class="keyword">list</span>-<span class="keyword">max</span>-ziplist-<span class="keyword">size</span> <span class="number">-2</span></span><br><span class="line"><span class="keyword">list</span>-<span class="keyword">compress</span>-<span class="keyword">depth</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">set</span>-<span class="keyword">max</span>-intset-entries <span class="number">512</span></span><br><span class="line">zset-<span class="keyword">max</span>-ziplist-entries <span class="number">128</span></span><br><span class="line">zset-<span class="keyword">max</span>-ziplist-<span class="keyword">value</span> <span class="number">64</span></span><br><span class="line">hll-<span class="keyword">sparse</span>-<span class="keyword">max</span>-<span class="keyword">bytes</span> <span class="number">3000</span></span><br><span class="line">activerehashing yes</span><br><span class="line"><span class="keyword">client</span>-<span class="keyword">output</span>-buffer-<span class="keyword">limit</span> <span class="keyword">normal</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">client</span>-<span class="keyword">output</span>-buffer-<span class="keyword">limit</span> <span class="keyword">slave</span> <span class="number">256</span>mb <span class="number">64</span>mb <span class="number">60</span></span><br><span class="line"><span class="keyword">client</span>-<span class="keyword">output</span>-buffer-<span class="keyword">limit</span> pubsub <span class="number">32</span>mb <span class="number">8</span>mb <span class="number">60</span></span><br><span class="line">hz <span class="number">10</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line"> </span><br><span class="line">slaveof <span class="number">192.168</span><span class="number">.1</span><span class="number">.14</span> <span class="number">6379</span></span><br><span class="line">masterauth ZDU0NTlkNDY5NWZi</span><br><span class="line">requirepass ZDU0NTlkNDY5NWZi<span class="string">' &gt;/opt/redis/redis.conf</span></span><br></pre></td></tr></table></figure></p><h1 id="4-配置防火墙-1"><a href="#4-配置防火墙-1" class="headerlink" title="4.配置防火墙"></a>4.配置防火墙</h1><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT <span class="number">5</span> -p tcp -m <span class="keyword">state</span> --state NEW -m tcp -m comment --comment <span class="string">"REDIS_SERVER"</span> -m multiport --dports <span class="number">6379</span> -j ACCEPT</span><br><span class="line">iptables -nvxL --lin</span><br></pre></td></tr></table></figure><h1 id="5-启动redis容器-1"><a href="#5-启动redis容器-1" class="headerlink" title="5.启动redis容器"></a>5.启动redis容器</h1><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">-privileged=<span class="literal">true</span> \</span></span><br><span class="line"><span class="ruby">--name redis-slave \</span></span><br><span class="line"><span class="ruby">--restart=always \</span></span><br><span class="line"><span class="ruby">-p <span class="number">6379</span><span class="symbol">:</span><span class="number">6379</span></span></span><br><span class="line"><span class="ruby">-v /opt/redis/redis.<span class="symbol">conf:</span>/opt/redis/redis.conf \</span></span><br><span class="line"><span class="ruby">-v /etc/<span class="symbol">localtime:</span>/etc/localtime \</span></span><br><span class="line"><span class="ruby">benyoo/<span class="symbol">redis:</span><span class="number">3.2</span>.<span class="number">5</span></span></span><br></pre></td></tr></table></figure><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">exec</span> <span class="selector-tag">-it</span> <span class="selector-tag">redis</span> <span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.15</span> <span class="selector-tag">-a</span> <span class="selector-tag">ZDU0NTlkNDY5NWZi</span> <span class="selector-tag">info</span> <span class="selector-tag">replication</span></span><br><span class="line"># <span class="selector-tag">Replication</span></span><br><span class="line"><span class="selector-tag">role</span><span class="selector-pseudo">:slave</span></span><br><span class="line"><span class="selector-tag">master_host</span><span class="selector-pseudo">:192.168.1.14</span></span><br><span class="line"><span class="selector-tag">master_port</span><span class="selector-pseudo">:6379</span></span><br><span class="line"><span class="selector-tag">master_link_status</span><span class="selector-pseudo">:up</span></span><br><span class="line"><span class="selector-tag">master_last_io_seconds_ago</span><span class="selector-pseudo">:9</span></span><br><span class="line"><span class="selector-tag">master_sync_in_progress</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">slave_repl_offset</span><span class="selector-pseudo">:281</span></span><br><span class="line"><span class="selector-tag">slave_priority</span><span class="selector-pseudo">:100</span></span><br><span class="line"><span class="selector-tag">slave_read_only</span><span class="selector-pseudo">:1</span></span><br><span class="line"><span class="selector-tag">connected_slaves</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">master_repl_offset</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">repl_backlog_active</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">repl_backlog_size</span><span class="selector-pseudo">:1048576</span></span><br><span class="line"><span class="selector-tag">repl_backlog_first_byte_offset</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">repl_backlog_histlen</span><span class="selector-pseudo">:0</span></span><br></pre></td></tr></table></figure><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis redis-<span class="keyword">cli</span> -h <span class="number">192.168</span><span class="number">.1</span><span class="number">.14</span> -a ZDU0NTlkNDY5NWZi info replication </span><br><span class="line"><span class="meta"># Replication</span></span><br><span class="line"><span class="symbol">role:</span>master</span><br><span class="line"><span class="symbol">connected_slaves:</span><span class="number">1</span></span><br><span class="line"><span class="symbol">slave0:</span>ip=<span class="number">192.168</span><span class="number">.1</span><span class="number">.15</span>,port=<span class="number">6379</span>,state=online,offset=<span class="number">295</span>,lag=<span class="number">1</span></span><br><span class="line"><span class="symbol">master_repl_offset:</span><span class="number">295</span></span><br><span class="line"><span class="symbol">repl_backlog_active:</span><span class="number">1</span></span><br><span class="line"><span class="symbol">repl_backlog_size:</span><span class="number">1048576</span></span><br><span class="line"><span class="symbol">repl_backlog_first_byte_offset:</span><span class="number">2</span></span><br><span class="line"><span class="symbol">repl_backlog_histlen:</span><span class="number">294</span></span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">exec</span> <span class="selector-tag">-it</span> <span class="selector-tag">redis</span> <span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.14</span> <span class="selector-tag">-a</span> <span class="selector-tag">ZDU0NTlkNDY5NWZi</span> <span class="selector-tag">set</span> <span class="selector-tag">Test_Write_key</span> <span class="selector-tag">www</span><span class="selector-class">.shangtv</span><span class="selector-class">.cn</span> #创建数据</span><br><span class="line"><span class="selector-tag">OK</span></span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">exec</span> <span class="selector-tag">-it</span> <span class="selector-tag">redis</span> <span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.14</span> <span class="selector-tag">-a</span> <span class="selector-tag">ZDU0NTlkNDY5NWZi</span> <span class="selector-tag">get</span> <span class="selector-tag">Test_Write_key</span> </span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.shangtv</span><span class="selector-class">.cn</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;基于docker搭建redis集群方案&lt;br&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="http://ippai.top/tags/Docker/"/>
    
      <category term="linux自动化运维" scheme="http://ippai.top/tags/linux%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>registry v2搭建</title>
    <link href="http://ippai.top/2018/04/08/registry-v2%E6%90%AD%E5%BB%BA/"/>
    <id>http://ippai.top/2018/04/08/registry-v2搭建/</id>
    <published>2018-04-08T03:16:20.000Z</published>
    <updated>2018-04-08T12:28:49.470Z</updated>
    
    <content type="html"><![CDATA[<h1 id="新版-registry-v2对镜像存储格式进行了重新设计，并且和旧版还不兼容。registry-v2是由go语言开发，docker从1-6版本开始支持registry-v2，之前python开发的老版registry在网上已被标为废弃了（没有维护更新，但也可以用）。"><a href="#新版-registry-v2对镜像存储格式进行了重新设计，并且和旧版还不兼容。registry-v2是由go语言开发，docker从1-6版本开始支持registry-v2，之前python开发的老版registry在网上已被标为废弃了（没有维护更新，但也可以用）。" class="headerlink" title="新版 registry v2对镜像存储格式进行了重新设计，并且和旧版还不兼容。registry v2是由go语言开发，docker从1.6版本开始支持registry v2，之前python开发的老版registry在网上已被标为废弃了（没有维护更新，但也可以用）。"></a>新版 registry v2对镜像存储格式进行了重新设计，并且和旧版还不兼容。registry v2是由go语言开发，docker从1.6版本开始支持registry v2，之前python开发的老版registry在网上已被标为废弃了（没有维护更新，但也可以用）。</h1><h1 id="之前在测试环境搭建了一个老版的registry，用了也比较久了。为了跟上技术的脚步，也准备今后使用新版registry-v2。由于对旧版是不兼容的，所以之前仓库的数据目录还不能直接拿来挂载，只好重新做个新的，镜像只好等以后慢慢再放上去了。下面对我这次配置的步骤简单的介绍一下。"><a href="#之前在测试环境搭建了一个老版的registry，用了也比较久了。为了跟上技术的脚步，也准备今后使用新版registry-v2。由于对旧版是不兼容的，所以之前仓库的数据目录还不能直接拿来挂载，只好重新做个新的，镜像只好等以后慢慢再放上去了。下面对我这次配置的步骤简单的介绍一下。" class="headerlink" title="之前在测试环境搭建了一个老版的registry，用了也比较久了。为了跟上技术的脚步，也准备今后使用新版registry v2。由于对旧版是不兼容的，所以之前仓库的数据目录还不能直接拿来挂载，只好重新做个新的，镜像只好等以后慢慢再放上去了。下面对我这次配置的步骤简单的介绍一下。"></a>之前在测试环境搭建了一个老版的registry，用了也比较久了。为了跟上技术的脚步，也准备今后使用新版registry v2。由于对旧版是不兼容的，所以之前仓库的数据目录还不能直接拿来挂载，只好重新做个新的，镜像只好等以后慢慢再放上去了。下面对我这次配置的步骤简单的介绍一下。</h1><h1 id="服务器环境"><a href="#服务器环境" class="headerlink" title="服务器环境"></a>服务器环境</h1><p>本次使用centos7.3的操作系统，服务器IP假设为：192.168.0.100<br>预先装好docker服务，操作如下：</p><h1 id="添加docker-repo安装源，写入文件"><a href="#添加docker-repo安装源，写入文件" class="headerlink" title="添加docker.repo安装源，写入文件"></a>添加docker.repo安装源，写入文件</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/yum.repos.d/docker.repo&lt;&lt;EOF</span><br><span class="line">[dockerrepo]</span><br><span class="line">name=Docker Repository</span><br><span class="line">baseurl=https://yum.dockerproject.org/repo/main/centos/7/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://yum.dockerproject.org/gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> docker-<span class="keyword">engine</span> -y</span><br><span class="line">systemctl <span class="keyword">enable</span> docker</span><br><span class="line">systemctl <span class="keyword">start</span> docker</span><br></pre></td></tr></table></figure><h1 id="1-获取最新的registry的容器-了解到目前最新版为2-4-1，于是直接使用docker-pull命令从公用仓库去拉即可"><a href="#1-获取最新的registry的容器-了解到目前最新版为2-4-1，于是直接使用docker-pull命令从公用仓库去拉即可" class="headerlink" title="1. 获取最新的registry的容器,了解到目前最新版为2.4.1，于是直接使用docker pull命令从公用仓库去拉即可"></a>1. 获取最新的registry的容器,了解到目前最新版为2.4.1，于是直接使用docker pull命令从公用仓库去拉即可</h1><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">pull</span> <span class="selector-tag">registry</span><span class="selector-pseudo">:2.4.1</span></span><br></pre></td></tr></table></figure><h1 id="2-运行registry-2-4-1容器"><a href="#2-运行registry-2-4-1容器" class="headerlink" title="2. 运行registry:2.4.1容器"></a>2. 运行registry:2.4.1容器</h1><p>这里需要注意的是新registry仓库数据目录的位置。之前老版的位置是/tmp/registry，hub.docker.com上的演示命令里写的是/tmp/registry-dev，其实这个不对。试验证明，新registry的仓库目录是在/var/lib/registry，所以运行时挂载目录需要注意。<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always \</span><br><span class="line">-<span class="ruby">v /opt/registry-var/<span class="symbol">:/var/lib/registry/</span> \</span></span><br><span class="line"><span class="ruby"><span class="symbol">registry:</span><span class="number">2.4</span>.<span class="number">1</span></span></span><br></pre></td></tr></table></figure></p><p>-v选项指定将/opt/registry-var/目录挂载给/var/lib/registry/<br>当使用curl <a href="http://192.168.0.100:5000/v2/_catalog能看到json格式的返回值时，说明registry已经运行起来了。" target="_blank" rel="noopener">http://192.168.0.100:5000/v2/_catalog能看到json格式的返回值时，说明registry已经运行起来了。</a></p><h1 id="3-修改配置文件以指定registry地址"><a href="#3-修改配置文件以指定registry地址" class="headerlink" title="3. 修改配置文件以指定registry地址"></a>3. 修改配置文件以指定registry地址</h1><p>上面registry虽然已经运行起来了，但是如果想用push命令上传镜像是会报错的，需要在配置文件中指定registry的地址。在/lib/systemd/system/docker.service文件中添加一下配置：<br>–insecure-registry 192.168.0.100:5000’</p><p>为了配置简单，省去安全相关的配置，这里使用–insecure-registry选项修改配置文件后，一定要重启docker服务才能生效，<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">systemctl restart docker</span></span><br></pre></td></tr></table></figure></p><p>这时再push就可以上传镜像到所搭建的registry仓库了。需要注意的是，上传前要先给镜像tag一个192.168.0.100:5000/为前缀的名字，这样才能在push的时候存到私库。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag docker.io/registry:<span class="number">2.4</span><span class="meta">.1</span> <span class="number">192.168</span><span class="meta">.0</span><span class="meta">.100</span>:<span class="number">5000</span>/registry:<span class="number">2.4</span><span class="meta">.1</span></span><br><span class="line">docker <span class="keyword">push</span> <span class="number">192.168</span><span class="meta">.0</span><span class="meta">.100</span>:<span class="number">5000</span>/registry:<span class="number">2.4</span><span class="meta">.1</span></span><br></pre></td></tr></table></figure></p><h1 id="4-配置带用户权限的registry"><a href="#4-配置带用户权限的registry" class="headerlink" title="4. 配置带用户权限的registry"></a>4. 配置带用户权限的registry</h1><p>到上面为止，registry已经可以使用了。如果想要控制registry的使用权限，使其只有在登录用户名和密码之后才能使用的话，还需要做额外的设置。</p><p>registry的用户名密码文件可以通过htpasswd来生成：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/opt/</span>registry-var<span class="regexp">/auth/</span></span><br><span class="line">docker run --entrypoint htpasswd <span class="string">registry:</span><span class="number">2.4</span><span class="number">.1</span> -Bbn felix felix  &gt;&gt; <span class="regexp">/opt/</span>registry-var<span class="regexp">/auth/</span>htpasswd</span><br></pre></td></tr></table></figure></p><p>上面这条命令是为felix用户名生成密码为felix的一条用户信息，存在/opt/registry-var/auth/htpasswd文件里面，文件中存的密码是被加密过的。<br>使用带用户权限的registry时候，容器的启动命令就跟上面不一样了，将之前的容器停掉并删除，然后执行下面的命令：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always \</span><br><span class="line">-<span class="ruby">v /opt/registry-var/auth/<span class="symbol">:/auth/</span> \</span></span><br><span class="line"><span class="ruby">-e <span class="string">"REGISTRY_AUTH=htpasswd"</span> \</span></span><br><span class="line"><span class="ruby">-e <span class="string">"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm"</span> \</span></span><br><span class="line"><span class="ruby">-e REGISTRY_AUTH_HTPASSWD_PATH=<span class="regexp">/auth/htpasswd</span> \</span></span><br><span class="line"><span class="ruby">-v /opt/registry-var/<span class="symbol">:/var/lib/registry/</span> \</span></span><br><span class="line"><span class="ruby"><span class="symbol">registry:</span><span class="number">2.4</span>.<span class="number">1</span></span></span><br></pre></td></tr></table></figure></p><p>这时，如果直接想查看仓库信息、pull或push都会出现权限报错。必须先使用docker login 命令来登录私有仓库：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">login</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.100</span><span class="selector-pseudo">:5000</span></span><br></pre></td></tr></table></figure></p><p>根据提示，输入用户名和密码即可。如果登录成功，会在/root/.docker/config.json文件中保存账户信息，这样就可以继续使用了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;新版-registry-v2对镜像存储格式进行了重新设计，并且和旧版还不兼容。registry-v2是由go语言开发，docker从1-6版本开始支持registry-v2，之前python开发的老版registry在网上已被标为废弃了（没有维护更新，但也可以用）
      
    
    </summary>
    
    
      <category term="Docker" scheme="http://ippai.top/tags/Docker/"/>
    
      <category term="linux自动化运维" scheme="http://ippai.top/tags/linux%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>etcd集群</title>
    <link href="http://ippai.top/2018/04/08/etcd%E9%9B%86%E7%BE%A4/"/>
    <id>http://ippai.top/2018/04/08/etcd集群/</id>
    <published>2018-04-08T02:47:45.000Z</published>
    <updated>2018-04-08T12:28:53.612Z</updated>
    
    <content type="html"><![CDATA[<h1 id="搭建集群etcd"><a href="#搭建集群etcd" class="headerlink" title="搭建集群etcd"></a>搭建集群etcd</h1><h1 id="安装etcd可以通过源码编译安装，也可以用yum安装，这里实验用yum安装"><a href="#安装etcd可以通过源码编译安装，也可以用yum安装，这里实验用yum安装" class="headerlink" title="安装etcd可以通过源码编译安装，也可以用yum安装，这里实验用yum安装"></a>安装etcd可以通过源码编译安装，也可以用yum安装，这里实验用yum安装</h1><a id="more"></a><p>Configure epel yum<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="regexp">//</span>dl.fedoraproject.org<span class="regexp">/pub/</span>epel<span class="regexp">/epel-release-latest-7.noarch.rpm &amp;&amp; rpm -ivh epel-release-latest-7.noarch.rpm</span></span><br></pre></td></tr></table></figure></p><p>install etcd<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y etcd</span><br></pre></td></tr></table></figure></p><p>configure host<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">"etcd1 192.168.1.100"</span> <span class="meta">&gt;&gt; </span>/etc/hosts</span><br><span class="line">echo <span class="string">"etcd2 192.168.1.200"</span> <span class="meta">&gt;&gt; </span>/etc/hosts</span><br></pre></td></tr></table></figure></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">IP</span>=$(ifconfig  eth1 |awk  -F <span class="string">'[: ]+'</span> <span class="string">'NR==2&#123;print $3&#125;'</span>)</span><br><span class="line"><span class="attr">IP1</span>=<span class="number">192.168</span>.<span class="number">1.100</span></span><br><span class="line"><span class="attr">IP2</span>=<span class="number">192.168</span>.<span class="number">1.200</span></span><br><span class="line"><span class="attr">HOST</span>=<span class="string">"etcd1=http://192.168.1.100:2380,etcd2=http://192.168.1.200:2380"</span></span><br></pre></td></tr></table></figure><figure class="highlight purebasic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function node1&#123;</span><br><span class="line"><span class="symbol">#Configure</span> the node1 etcd file</span><br><span class="line">sed -i 's#\<span class="symbol">#ETCD_LISTEN_PEER_URLS</span>=<span class="string">"http://localhost:2380"</span><span class="symbol">#ETCD_LISTEN_PEER_URLS</span>=<span class="string">"http://$&#123;IP1&#125;:2380"</span><span class="symbol">#g</span>' /etc/etcd/etcd.conf</span><br><span class="line">sed -i 's<span class="symbol">#ETCD_LISTEN_CLIENT_URLS</span>=<span class="string">"http://localhost:2379"</span><span class="symbol">#ETCD_LISTEN_CLIENT_URLS</span>=<span class="string">"http://0.0.0.0:2379"</span><span class="symbol">#g</span>' /etc/etcd/etcd.conf</span><br><span class="line">sed -i 's<span class="symbol">#ETCD_ADVERTISE_CLIENT_URLS</span>=<span class="string">"http://localhost:2379"</span><span class="symbol">#ETCD_ADVERTISE_CLIENT_URLS</span>=<span class="string">"http://$&#123;IP1&#125;:2379"</span><span class="symbol">#g</span>' /etc/etcd/etc.conf</span><br><span class="line">sed -i 's#\<span class="symbol">#ETCD_INITIAL_CLUSTER</span>=<span class="string">"default=http://localhost:2380"</span><span class="symbol">#ETCD_INITIAL_CLUSTER</span>=<span class="string">"$&#123;HOST&#125;"</span>#'g</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function node2&#123;</span><br><span class="line"><span class="symbol">#Configure</span> the node2 etcd file</span><br><span class="line">sed -i 's#\<span class="symbol">#ETCD_LISTEN_PEER_URLS</span>=<span class="string">"http://localhost:2380"</span><span class="symbol">#ETCD_LISTEN_PEER_URLS</span>=<span class="string">"http://$&#123;IP2&#125;:2380"</span><span class="symbol">#g</span>' /etc/etcd/etcd.conf</span><br><span class="line">sed -i 's<span class="symbol">#ETCD_LISTEN_CLIENT_URLS</span>=<span class="string">"http://localhost:2379"</span><span class="symbol">#ETCD_LISTEN_CLIENT_URLS</span>=<span class="string">"http://0.0.0.0:2379"</span><span class="symbol">#g</span>' /etc/etcd/etcd.conf</span><br><span class="line">sed -i 's<span class="symbol">#ETCD_ADVERTISE_CLIENT_URLS</span>=<span class="string">"http://localhost:2379"</span><span class="symbol">#ETCD_ADVERTISE_CLIENT_URLS</span>=<span class="string">"http://$&#123;IP2&#125;:2379"</span><span class="symbol">#g</span>' /etc/etcd/etc.conf</span><br><span class="line">sed -i 's#\<span class="symbol">#ETCD_INITIAL_CLUSTER</span>=<span class="string">"default=http://localhost:2380"</span><span class="symbol">#ETCD_INITIAL_CLUSTER</span>=<span class="string">"$&#123;HOST&#125;"</span><span class="symbol">#g</span>' /etc/etcd/etc.conf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start&#123;</span><br><span class="line">systemctl enable etcd</span><br><span class="line">systemctl restart etcd</span><br><span class="line">systemctl status etcd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ <span class="string">"$IP"</span>==<span class="string">"$IP1"</span> ]<span class="comment">;then</span></span><br><span class="line">node1</span><br><span class="line">start</span><br><span class="line">else</span><br><span class="line">node2</span><br><span class="line">start</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>look etcd node list<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member <span class="built_in">list</span></span><br></pre></td></tr></table></figure></p><p>look etcd node status<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">etcdctl  cluster-health</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;搭建集群etcd&quot;&gt;&lt;a href=&quot;#搭建集群etcd&quot; class=&quot;headerlink&quot; title=&quot;搭建集群etcd&quot;&gt;&lt;/a&gt;搭建集群etcd&lt;/h1&gt;&lt;h1 id=&quot;安装etcd可以通过源码编译安装，也可以用yum安装，这里实验用yum安装&quot;&gt;&lt;a href=&quot;#安装etcd可以通过源码编译安装，也可以用yum安装，这里实验用yum安装&quot; class=&quot;headerlink&quot; title=&quot;安装etcd可以通过源码编译安装，也可以用yum安装，这里实验用yum安装&quot;&gt;&lt;/a&gt;安装etcd可以通过源码编译安装，也可以用yum安装，这里实验用yum安装&lt;/h1&gt;
    
    </summary>
    
    
      <category term="linux自动化运维" scheme="http://ippai.top/tags/linux%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"/>
    
      <category term="etcd" scheme="http://ippai.top/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>Add User Script</title>
    <link href="http://ippai.top/2018/04/04/Add-User-Script/"/>
    <id>http://ippai.top/2018/04/04/Add-User-Script/</id>
    <published>2018-04-04T10:39:32.000Z</published>
    <updated>2018-04-08T12:07:03.665Z</updated>
    
    <content type="html"><![CDATA[<h2 id="服务器自动添加用户，并发送邮件"><a href="#服务器自动添加用户，并发送邮件" class="headerlink" title="服务器自动添加用户，并发送邮件"></a>服务器自动添加用户，并发送邮件</h2><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">password=&quot;password&quot;</span><br><span class="line">ip=`ifconfig eth1 |grep inet |awk &apos;&#123;printf &quot;IP:&quot;&#125;&apos;&apos;&#123;print $2&#125;&apos;`</span><br><span class="line">echo &quot;请输入要创建的用户名：&quot;</span><br><span class="line">read username</span><br><span class="line">echo &quot;您输入的用户名为: $username&quot;</span><br><span class="line">egrep &quot;^servergroups&quot; /etc/group &gt;&amp; /dev/null</span><br><span class="line">if [ $? -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    groupadd servergroups</span><br><span class="line">else</span><br><span class="line">    echo &quot;已存在servergroups组&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">egrep &quot;^$username&quot; /etc/passwd &gt;&amp; /dev/null</span><br><span class="line">if [ $? -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    useradd $username &amp;&amp; \</span><br><span class="line">    usermod -aG servergroups $username &amp;&amp; \</span><br><span class="line">    echo $username | passwd --stdin $username</span><br><span class="line">    chage -d 0 $username</span><br><span class="line">    echo &quot;创建 $username 用户成功&quot;</span><br><span class="line">    #echo &quot;密码为:$password&quot;</span><br><span class="line">    id $username</span><br><span class="line">    text=&quot;用户名：$username\n密码为：$username\n$ip\n注意：第一次登陆必须要修改密码!!!!&quot;</span><br><span class="line">    echo -e &quot;$text&quot; | mail -s &quot;$username,服务器用户创建成功，请及时修改密码!!&quot; $username@qq.com</span><br><span class="line">else</span><br><span class="line">    echo &quot;$username 已存在&quot;</span><br><span class="line">    id $username</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;服务器自动添加用户，并发送邮件&quot;&gt;&lt;a href=&quot;#服务器自动添加用户，并发送邮件&quot; class=&quot;headerlink&quot; title=&quot;服务器自动添加用户，并发送邮件&quot;&gt;&lt;/a&gt;服务器自动添加用户，并发送邮件&lt;/h2&gt;
    
    </summary>
    
    
      <category term="Linux自动化之路" scheme="http://ippai.top/tags/Linux%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8B%E8%B7%AF/"/>
    
  </entry>
  
  <entry>
    <title>你好，Oliver</title>
    <link href="http://ippai.top/2018/04/04/%E4%BD%A0%E5%A5%BD%EF%BC%8COliver/"/>
    <id>http://ippai.top/2018/04/04/你好，Oliver/</id>
    <published>2018-04-04T03:57:04.000Z</published>
    <updated>2018-04-04T03:57:04.239Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
</feed>
